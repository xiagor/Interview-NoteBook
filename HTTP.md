## 缓存

### 1. 为什么需要缓存

+ 冗余的数据传输（总是传相同的东西）
+ 带宽瓶颈（客户端的宽带比服务器的宽带要宽，访问速度就慢）
+ 瞬间拥塞（有爆炸性新闻）
+ 距离时延（客户端和服务器太远了）

### 2. 缓存的命中和未命中

- 可以用已有的副本为某些到达缓存的请求提供服务,这被称之为缓存命中（就是有可以用的缓存副本）

  ![img](Images/HTTP/162fcfaa771243b4)

- 其他一些到达缓存的请求可能会由于没有副本可用,而被转发给原始服务器,这被称之为缓存未命中（没有缓存副本，要向服务器要）

![img](Images/HTTP/162fcfab46a3b1c3)



### 3. 新鲜度检测规则

#### 1）强缓存

HTTP通过缓存将服务器文档的副本保留一段时间。在这段时间里,都认为文档时新鲜的,缓存可以在不联系服务器的情况下,直接提供该文档。我们称之为**强缓存命中**,此时浏览器会返回200状态码(from cache)

![img](Images/HTTP/162fcfaa771243b4)

但一旦以缓存副本停留的时间太长,超过了文档的新鲜度限值,就认为文档过期了。

![img](Images/HTTP/162fcfaa7726cf25)



#### 2）协商缓存

在提供文档之前，缓存都要再次与服务器进行再验证，查看文档是否发生变化，我们称之为**协商缓存**。

![img](Images/HTTP/162fcfaa770151bc)

+ 验证命中：如果服务器对象没有被修改,服务器会向客户端发送一个小的HTTP `304 Not Modeified`响应
+ 验证未命中：如果服务器对象与以缓存副本不同,服务器向客户端送一条普通的带有完整内容的HTTP `200 ok` 响应
+ 对象被删除：如果服务器对象已经被删除了,服务器就回送一个404 Not Found 响应,缓存也会将其副本删除



### 4. 强缓存原理

+ `Cache-Control`（通用首部字段）：控制缓存的行为

  + `max-age`值定义了文档的最大使用期——从第一次生成文档到文档不再新鲜,无法使用为止,最大的合法生存时间(以秒为单位)

  + 缓存请求指令（浏览器的）

    | 指令             | 参数   | 说明                         |
    | ---------------- | ------ | ---------------------------- |
    | no-cache         | 无     | 强制向源服务器再次验证       |
    | no-store         | 无     | 不缓存请求或响应的任何内容   |
    | max-age=[秒]     | 必需   | 响应的最大使用期值           |
    | max-stale(=[秒]) | 可省略 | 接受已过期的响应             |
    | min-fresh=[秒]   | 必需   | 期待在指定时间内的响应仍有效 |
    | no-transform     | 无     | 代理不可更改媒体的类型       |
    | only-if-cached   | 无     | 从缓存获取资源               |
    | cache-extension  | -      | 新指令标记(token)            |

  + 最佳`Cache-Control`策略：

    ![img](Images/HTTP/162fcfab954de5e8)

    

+ `Expries`（实体首部字段）：实体主体过期的日期时间
  
  + 指定一个绝对的过期日期，由于我们可以去更改客户端的时间，这样就可以改变缓存命中的结果，因此优先使用`Cache-Control`



浏览器第二次发送请求相同资源时，拿出过期日期和当前时间进行比较，如果在过期日期之前，则**强缓存命中**；

如果缓存文档过期，缓存就必须与服务器进行核对，询问文档是否过期，如果被修改过，就要获取一份新鲜（带有新的`Expries`）的副本。



![img](https://user-gold-cdn.xitu.io/2018/4/25/162fcfab20444de3?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

